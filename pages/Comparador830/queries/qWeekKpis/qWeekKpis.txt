SELECT

COUNT(DISTINCT d.part_number) AS parts_affected,

COUNT(DISTINCT CASE
WHEN d.diff_value > 0 THEN d.part_number
END) AS parts_increase,

COUNT(DISTINCT CASE
WHEN d.diff_value < 0 THEN d.part_number
END) AS parts_decrease,

COALESCE(SUM(CASE
WHEN d.diff_value > 0 THEN d.diff_value
END),0) AS total_produce,

COALESCE(SUM(CASE
WHEN d.diff_value < 0 THEN ABS(d.diff_value)
END),0) AS total_reduce,

COALESCE(MAX(CASE
WHEN d.diff_value > 0 THEN d.diff_value
END),0) AS max_increase,

COALESCE(MAX(CASE
WHEN d.diff_value < 0 THEN ABS(d.diff_value)
END),0) AS max_reduce

FROM file_compare_runs r
JOIN file_compare_diffs d ON d.run_id = r.id

WHERE r.year_week = {{ select_week.selectedOptionValue }}

