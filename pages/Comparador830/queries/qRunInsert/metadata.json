{
  "gitSyncId": "69907fc86e9d3f3f72205f7c_4ecb70e1-6c65-48c7-968b-570f56d3391b",
  "id": "Comparador830_qRunInsert",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH payload AS (\n  SELECT\n    {{ appsmith.user.email }}::text            AS created_by_email,\n    {{ appsmith.user.name }}::text             AS created_by_name,\n    'Comparador 830'::text                     AS tool_name,\n    '830'::text                                AS compare_type,\n\n    {{ moment().format(\"YYYY-MM\") }}::text     AS period_key,\n    {{ moment().year() }}::int                 AS year,\n    {{ moment().month() + 1 }}::int            AS month,\n    {{ moment().isoWeek() }}::int              AS iso_week,\n    {{ moment().format(\"GGGG-[W]WW\") }}::text  AS year_week,\n\n    {{ this.params.comp?.prev_filename || this.params.comp?.prevFilename || null }}::text AS prev_filename,\n    {{ this.params.comp?.curr_filename || this.params.comp?.currFilename || null }}::text AS curr_filename,\n\n    {{ (this.params.comp?.diferencias_count ?? 0) > 0 }}::boolean AS has_differences,\n    {{ (this.params.comp?.diferencias_count ?? 0) }}::int         AS differences_count,\n\n    {{ Number(this.params.comp?.total_prev ?? this.params.comp?.total_anterior ?? 0) }}::numeric AS total_prev,\n    {{ Number(this.params.comp?.total_curr ?? this.params.comp?.total_actual ?? 0) }}::numeric AS total_curr,\n    {{ Number(this.params.comp?.total_variation ?? this.params.comp?.variacion_total ?? 0) }}::numeric AS total_variation,\n\n    {{ JSON.stringify(this.params.comp || {}) }}::jsonb AS raw_summary\n),\nhashed AS (\n  SELECT\n    *,\n    md5(raw_summary::text) AS compare_hash\n  FROM payload\n),\nins AS (\n  INSERT INTO file_compare_runs (\n    created_by_email,\n    created_by_name,\n    tool_name,\n    compare_type,\n    period_key,\n    year,\n    month,\n    iso_week,\n    year_week,\n    prev_filename,\n    curr_filename,\n    has_differences,\n    differences_count,\n    total_prev,\n    total_curr,\n    total_variation,\n    raw_summary,\n    compare_hash\n  )\n  SELECT\n    created_by_email,\n    created_by_name,\n    tool_name,\n    compare_type,\n    period_key,\n    year,\n    month,\n    iso_week,\n    year_week,\n    prev_filename,\n    curr_filename,\n    has_differences,\n    differences_count,\n    total_prev,\n    total_curr,\n    total_variation,\n    raw_summary,\n    compare_hash\n  FROM hashed\n  ON CONFLICT (year_week, compare_hash) DO NOTHING\n  RETURNING id\n)\nSELECT id\nFROM ins\nUNION ALL\nSELECT r.id\nFROM file_compare_runs r\nJOIN hashed h\n  ON r.year_week = h.year_week\n AND r.compare_hash = h.compare_hash\nLIMIT 1;\n\n\n\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Control Tower",
      "isAutoGenerated": false,
      "name": "Control Tower",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "qRunInsert",
    "pageId": "Comparador830",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}