{
  "gitSyncId": "69907fc86e9d3f3f72205f7c_718fa27b-f37c-46d9-acb3-b9137571d89a",
  "id": "Comparador830_qTrendVsPrevWeek",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH params AS (\n  SELECT\n    {{ select_week_a.selectedOptionValue }}::text AS week_a,\n    {{ select_week_b.selectedOptionValue }}::text AS week_b\n),\nagg AS (\n  SELECT\n    r.year_week AS week,\n    COALESCE(SUM(CASE WHEN d.diff_value > 0 THEN d.diff_value END), 0) AS total_produce,\n    COALESCE(SUM(CASE WHEN d.diff_value < 0 THEN ABS(d.diff_value) END), 0) AS total_reduce,\n    COUNT(DISTINCT d.part_number) AS parts_affected\n  FROM file_compare_runs r\n  JOIN file_compare_diffs d ON d.run_id = r.id\n  WHERE r.year_week IN ((SELECT week_a FROM params), (SELECT week_b FROM params))\n  GROUP BY r.year_week\n),\ntwo AS (\n  SELECT\n    p.week_a,\n    p.week_b,\n    COALESCE(a.total_produce,0) AS a_total_produce,\n    COALESCE(a.total_reduce,0)  AS a_total_reduce,\n    COALESCE(a.parts_affected,0) AS a_parts_affected,\n    COALESCE(b.total_produce,0) AS b_total_produce,\n    COALESCE(b.total_reduce,0)  AS b_total_reduce,\n    COALESCE(b.parts_affected,0) AS b_parts_affected\n  FROM params p\n  LEFT JOIN agg a ON a.week = p.week_a\n  LEFT JOIN agg b ON b.week = p.week_b\n)\nSELECT\n  metric,\n  week_label,\n  value\nFROM (\n  SELECT 'total_produce'  AS metric, (SELECT week_a FROM two) AS week_label, (SELECT a_total_produce FROM two)  AS value\n  UNION ALL\n  SELECT 'total_produce', (SELECT week_b FROM two), (SELECT b_total_produce FROM two)\n\n  UNION ALL\n  SELECT 'total_reduce',  (SELECT week_a FROM two), (SELECT a_total_reduce FROM two)\n  UNION ALL\n  SELECT 'total_reduce',  (SELECT week_b FROM two), (SELECT b_total_reduce FROM two)\n\n  UNION ALL\n  SELECT 'parts_affected',(SELECT week_a FROM two), (SELECT a_parts_affected FROM two)\n  UNION ALL\n  SELECT 'parts_affected',(SELECT week_b FROM two), (SELECT b_parts_affected FROM two)\n) x\nORDER BY metric, week_label;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "Control Tower",
      "isAutoGenerated": false,
      "name": "Control Tower",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "qTrendVsPrevWeek",
    "pageId": "Comparador830",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}